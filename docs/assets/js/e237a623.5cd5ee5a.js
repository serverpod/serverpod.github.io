"use strict";(self.webpackChunkserverpod_docs=self.webpackChunkserverpod_docs||[]).push([[65692],{684:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>d,default:()=>h,frontMatter:()=>s,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"concepts/webserver/middleware","title":"Middleware","description":"Routes handle the core logic of your application, but many concerns cut across","source":"@site/versioned_docs/version-3.1.0/06-concepts/18-webserver/04-middleware.md","sourceDirName":"06-concepts/18-webserver","slug":"/concepts/webserver/middleware","permalink":"/concepts/webserver/middleware","draft":false,"unlisted":false,"editUrl":"https://github.com/serverpod/serverpod_docs/tree/main/versioned_docs/version-3.1.0/06-concepts/18-webserver/04-middleware.md","tags":[],"version":"3.1.0","sidebarPosition":4,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Request Data","permalink":"/concepts/webserver/request-data"},"next":{"title":"Static files","permalink":"/concepts/webserver/static-files"}}');var a=t(74848),i=t(28453);const s={},d="Middleware",o={},l=[{value:"Adding middleware",id:"adding-middleware",level:2},{value:"Creating custom middleware",id:"creating-custom-middleware",level:2},{value:"Middleware execution order",id:"middleware-execution-order",level:2},{value:"Request-scoped data",id:"request-scoped-data",level:2},{value:"Creating a <code>ContextProperty</code>",id:"creating-a-contextproperty",level:3},{value:"Setting values in middleware",id:"setting-values-in-middleware",level:3},{value:"Accessing values in routes",id:"accessing-values-in-routes",level:3},{value:"Next steps",id:"next-steps",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"middleware",children:"Middleware"})}),"\n",(0,a.jsx)(n.p,{children:"Routes handle the core logic of your application, but many concerns cut across\nmultiple routes: logging every request, validating API keys, handling CORS\nheaders, or catching errors. Rather than duplicating this code in each route,\nmiddleware lets you apply it globally or to specific path prefixes."}),"\n",(0,a.jsx)(n.p,{children:"Middleware functions are wrappers that sit between the incoming request and your\nroute handler. They can inspect or modify requests before they reach your\nroutes, and transform responses before they're sent back to the client. This\nmakes middleware perfect for authentication, logging, error handling, and any\nother cross-cutting concern in your web server."}),"\n",(0,a.jsx)(n.h2,{id:"adding-middleware",children:"Adding middleware"}),"\n",(0,a.jsxs)(n.p,{children:["Use the ",(0,a.jsx)(n.code,{children:"addMiddleware"})," method to apply middleware to specific path prefixes:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"// Apply to all routes below `/path`\npod.webServer.addMiddleware(myMiddleware, '/path');\n"})}),"\n",(0,a.jsx)(n.h2,{id:"creating-custom-middleware",children:"Creating custom middleware"}),"\n",(0,a.jsxs)(n.p,{children:["Middleware is a function that takes a ",(0,a.jsx)(n.code,{children:"Handler"})," and returns a new ",(0,a.jsx)(n.code,{children:"Handler"}),".\nHere's a simple example that validates API keys for protected routes:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"Handler apiKeyMiddleware(Handler next) {\n  return (Request request) async {\n    // Check for API key in header\n    final apiKey = request.headers['X-API-Key']?.firstOrNull;\n\n    if (apiKey == null) {\n      return Response.unauthorized(\n        body: Body.fromString('API key required'),\n      );\n    }\n\n    // Verify API key\n    if (!await isValidApiKey(apiKey)) {\n      return Response.forbidden(\n        body: Body.fromString('Invalid API key'),\n      );\n    }\n\n    // Continue to the next handler\n    return await next(request);\n  };\n}\n\n// Apply to protected routes\npod.webServer.addMiddleware(apiKeyMiddleware, '/api');\n"})}),"\n",(0,a.jsx)(n.admonition,{type:"info",children:(0,a.jsxs)(n.p,{children:["For user authentication, use Serverpod's built-in authentication system which\nintegrates with the ",(0,a.jsx)(n.code,{children:"Session"})," object. The middleware examples here are for\nadditional web-specific validations like API keys, rate limiting, or request\nvalidation."]})}),"\n",(0,a.jsx)(n.h2,{id:"middleware-execution-order",children:"Middleware execution order"}),"\n",(0,a.jsx)(n.p,{children:"Middleware is applied based on path hierarchy, with more specific paths taking\nprecedence. Within the same path, middleware executes in the order it was\nregistered:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"pod.webServer.addMiddleware(rateLimitMiddleware, '/api/users'); // Executes last for /api (inner)\npod.webServer.addMiddleware(apiKeyMiddleware, '/api');          // Executes first for /api (outer)\n"})}),"\n",(0,a.jsxs)(n.p,{children:["For a request to ",(0,a.jsx)(n.code,{children:"/api/users/list"}),", the execution order is:"]}),"\n",(0,a.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant Client\n    participant Auth as apiKeyMiddleware\n    participant RateLimit as rateLimitMiddleware\n    participant Handler as Route Handler\n\n    Client->>Auth: \n    activate Auth\n    Note over Auth: Before logic\n    Auth->>RateLimit: \n    activate RateLimit\n    Note over RateLimit: Before logic\n    RateLimit->>Handler: \n    activate Handler\n    Note over Handler: Execute route logic\n    Handler--\x3e>RateLimit: Response\n    deactivate Handler\n    Note over RateLimit: After logic\n    RateLimit--\x3e>Auth: \n    deactivate RateLimit\n    Note over Auth: After logic\n    Auth--\x3e>Client: Response"}),"\n",(0,a.jsx)(n.h2,{id:"request-scoped-data",children:"Request-scoped data"}),"\n",(0,a.jsxs)(n.p,{children:["Middleware often needs to pass computed data to downstream handlers. For\nexample, a tenant identification middleware might extract the tenant ID from a\nsubdomain, or a logging middleware might generate a request ID for tracing.\nSince ",(0,a.jsx)(n.code,{children:"Request"})," objects are immutable, you can't just add properties to them.\nThis is where ",(0,a.jsx)(n.code,{children:"ContextProperty"})," comes in."]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"ContextProperty<T>"})," provides a type-safe way to attach data to a ",(0,a.jsx)(n.code,{children:"Request"}),"\nobject without modifying it. Think of it as a side channel for request-scoped\ndata that middleware can write to and routes can read from. The data is\nautomatically cleaned up when the request completes, making it perfect for\nper-request state. For more details, see the ",(0,a.jsx)(n.a,{href:"https://docs.dartrelic.dev/",children:"Relic documentation"}),"."]}),"\n",(0,a.jsx)(n.admonition,{type:"info",children:(0,a.jsxs)(n.p,{children:["Note that Serverpod's ",(0,a.jsx)(n.code,{children:"Route.handleCall()"})," already receives a ",(0,a.jsx)(n.code,{children:"Session"})," parameter\nwhich includes authenticated user information if available. Use ",(0,a.jsx)(n.code,{children:"ContextProperty"}),"\nfor web-specific request data that isn't part of the standard Session, such as\nrequest IDs, feature flags, or API version information extracted from headers."]})}),"\n",(0,a.jsxs)(n.h3,{id:"creating-a-contextproperty",children:["Creating a ",(0,a.jsx)(n.code,{children:"ContextProperty"})]}),"\n",(0,a.jsxs)(n.p,{children:["Define a ",(0,a.jsx)(n.code,{children:"ContextProperty"})," as a top-level static field:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"// Define a private context property.\nfinal _tenantProperty = ContextProperty<String>('tenant');\n\n// Create a public getter extension to allow handlers and other middleware to\n// read, but not modify the context property.\nextension tenantPropertyEx on Request {\n  String get tenant => _tenantProperty.get(this); // get throw on null, [] doesn't  \n}\n"})}),"\n",(0,a.jsx)(n.h3,{id:"setting-values-in-middleware",children:"Setting values in middleware"}),"\n",(0,a.jsx)(n.p,{children:"Middleware can set values on the context property, making them available to all\ndownstream handlers:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"// in same file\n \n// Tenant identification middleware (extracts from subdomain)\nHandler tenantMiddleware(Handler next) {\n  return (Request request) async {\n    final host = request.headers.host;\n\n    // Validate tenant exists (implement your own logic)\n    final session = request.session;\n    final tenant = await extractAndValidateTenant(session, host);\n\n    if (tenant == null) {\n      return Response.notFound(\n        body: Body.fromString('Tenant not found'),\n      );\n    }\n\n    // Attach tenant to context\n    _tenantProperty[request] = tenant;\n\n    return await next(request);\n  };\n}\n"})}),"\n",(0,a.jsx)(n.h3,{id:"accessing-values-in-routes",children:"Accessing values in routes"}),"\n",(0,a.jsx)(n.p,{children:"Route handlers can retrieve the value from the context property:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"// Routes automatically have access to the tenant\nclass TenantDataRoute extends Route {\n  @override\n  Future<Result> handleCall(Session session, Request request) async {\n    final tenant = request.tenant; // using the previously defined extension\n\n    // Fetch tenant-specific data\n    final data = await session.db.find<Product>(\n      where: (p) => p.tenantId.equals(tenant),\n    );\n\n    return Response.ok(\n      body: Body.fromString(\n        jsonEncode(data.map((p) => p.toJson()).toList()),\n        mimeType: MimeType.json,\n      ),\n    );\n  }\n}\n"})}),"\n",(0,a.jsx)(n.h2,{id:"next-steps",children:"Next steps"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:(0,a.jsx)(n.a,{href:"request-data",children:"Request Data"})})," - Access path parameters, query parameters, headers, and body"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:(0,a.jsx)(n.a,{href:"static-files",children:"Static Files"})})," - Serve static assets"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:(0,a.jsx)(n.a,{href:"server-side-html",children:"Server-side HTML"})})," - Render HTML dynamically on the server"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(c,{...e})}):c(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>d});var r=t(96540);const a={},i=r.createContext(a);function s(e){const n=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);