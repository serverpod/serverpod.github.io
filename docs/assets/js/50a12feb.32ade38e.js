"use strict";(self.webpackChunkserverpod_docs=self.webpackChunkserverpod_docs||[]).push([[97499],{14294:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"concepts/authentication/setup","title":"Setup","description":"Serverpod comes with built-in user management and authentication. It is possible to build a custom authentication implementation, but the recommended way to authenticate users is to use the serverpodauthidp module. The module makes it easy to authenticate with email, social sign-ins and more.","source":"@site/docs/06-concepts/11-authentication/01-setup.md","sourceDirName":"06-concepts/11-authentication","slug":"/concepts/authentication/setup","permalink":"/next/concepts/authentication/setup","draft":false,"unlisted":false,"editUrl":"https://github.com/serverpod/serverpod_docs/tree/main/docs/06-concepts/11-authentication/01-setup.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Modules","permalink":"/next/concepts/modules"},"next":{"title":"The basics","permalink":"/next/concepts/authentication/basics"}}');var r=t(74848),s=t(28453);const a={},o="Setup",d={},l=[{value:"Installing the auth module",id:"installing-the-auth-module",level:2},{value:"Server setup",id:"server-setup",level:2},{value:"Configure Authentication Services",id:"configure-authentication-services",level:3},{value:"Token Manager Configuration",id:"token-manager-configuration",level:3},{value:"Identity Providers Configuration",id:"identity-providers-configuration",level:3},{value:"Storing Secrets",id:"storing-secrets",level:3},{value:"Client setup",id:"client-setup",level:2},{value:"App setup",id:"app-setup",level:2},{value:"Initialize authentication",id:"initialize-authentication",level:3},{value:"Present the authentication UI",id:"present-the-authentication-ui",level:3},{value:"Updating the UI based on authentication state",id:"updating-the-ui-based-on-authentication-state",level:4}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"setup",children:"Setup"})}),"\n",(0,r.jsxs)(n.p,{children:["Serverpod comes with built-in user management and authentication. It is possible to build a ",(0,r.jsx)(n.a,{href:"custom-overrides",children:"custom authentication implementation"}),", but the recommended way to authenticate users is to use the ",(0,r.jsx)(n.code,{children:"serverpod_auth_idp"})," module. The module makes it easy to authenticate with email, social sign-ins and more."]}),"\n",(0,r.jsxs)(n.p,{children:["The list of identity providers is continuously growing and new providers are added as they are developed. If you want to contribute a new provider, please consider ",(0,r.jsx)(n.a,{href:"/contribute",children:"contributing"})," your code. See the ",(0,r.jsx)(n.a,{href:"#identity-providers-configuration",children:"identity providers configuration"})," section for details on all available providers."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Sign-in with Serverpod",src:t(87753).A+"",width:"606",height:"707"})}),"\n",(0,r.jsx)(n.h2,{id:"installing-the-auth-module",children:"Installing the auth module"}),"\n",(0,r.jsx)(n.p,{children:"Serverpod's auth module makes it easy to authenticate users through email or 3rd parties. The authentication module also handles basic user information, such as user names and profile pictures. Make sure to use the same version numbers as for Serverpod itself for all dependencies."}),"\n",(0,r.jsx)(n.h2,{id:"server-setup",children:"Server setup"}),"\n",(0,r.jsxs)(n.p,{children:["Add the auth modules as dependencies to the server project's ",(0,r.jsx)(n.code,{children:"pubspec.yaml"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"dependencies:\n  ...\n  serverpod_auth_idp_server: 3.x.x\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"serverpod_auth_idp_server"})," package contains all components required to configure authentication services."]}),"\n",(0,r.jsx)(n.h3,{id:"configure-authentication-services",children:"Configure Authentication Services"}),"\n",(0,r.jsxs)(n.p,{children:["In your main ",(0,r.jsx)(n.code,{children:"server.dart"})," file, configure the authentication system using the ",(0,r.jsx)(n.code,{children:"pod.initializeAuthServices()"})," extension method."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"import 'package:serverpod/serverpod.dart';\nimport 'package:serverpod_auth_idp_server/core.dart';\n\nimport 'src/generated/protocol.dart';\nimport 'src/generated/endpoints.dart';\n\nvoid run(List<String> args) async {\n  final pod = Serverpod(\n    args,\n    Protocol(),\n    Endpoints(),\n  );\n\n  // Set up authentication services\n  // The `pod.getPassword()` will get the value from `config/passwords.yaml`.\n  pod.initializeAuthServices(\n    tokenManagerBuilders: [\n      JwtConfig(\n        // Pepper used to hash the refresh token secret.\n        refreshTokenHashPepper: pod.getPassword('jwtRefreshTokenHashPepper')!,\n        // Algorithm used to sign the tokens (`hmacSha512` or `ecdsaSha512`).\n        algorithm: JwtAlgorithm.hmacSha512(\n          // Private key to sign the tokens. Must be a valid HMAC SHA-512 key.\n          SecretKey(pod.getPassword('jwtHmacSha512PrivateKey')!),\n        )\n      ),\n    ],\n  );\n\n  await pod.start();\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"Then, extend the abstract endpoint for refreshing JWT tokens to expose it on the server:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"import 'package:serverpod_auth_idp_server/core.dart' as core;\n\nclass RefreshJwtTokensEndpoint extends core.RefreshJwtTokensEndpoint {}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"token-manager-configuration",children:"Token Manager Configuration"}),"\n",(0,r.jsx)(n.p,{children:"The authentication system uses token managers to handle authentication tokens. You need to configure at least one token manager to be used as the primary token manager. Additional token managers can be configured to be used for validation and management operations."}),"\n",(0,r.jsx)(n.p,{children:"Serverpod provides two built-in token manager builders:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"JwtConfig"})," to use JWT-based authentication. See ",(0,r.jsx)(n.a,{href:"./token-managers/jwt-token-manager",children:"JWT Token Manager"})," for details."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"ServerSideSessionsConfig"})," to use server-side sessions authentication. See ",(0,r.jsx)(n.a,{href:"./token-managers/server-side-sessions-token-manager",children:"Server-Side Sessions Token Manager"})," for details."]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["For more details on how to configure token managers or create custom ones, see the dedicated ",(0,r.jsx)(n.a,{href:"./token-managers/managing-tokens",children:"Token Managers"})," documentation."]}),"\n",(0,r.jsx)(n.h3,{id:"identity-providers-configuration",children:"Identity Providers Configuration"}),"\n",(0,r.jsx)(n.p,{children:"Identity providers handle authentication with different methods (Email, Google, Apple, etc.). Each provider has its own configuration:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Email"}),": Sign-up and sign-in with email and password. See ",(0,r.jsx)(n.a,{href:"./providers/email/setup",children:"Email Provider"})," for details."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Google"}),": Sign-in with Google. See ",(0,r.jsx)(n.a,{href:"./providers/google/setup",children:"Google Provider"})," for details."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Apple"}),": Sign-in with Apple. See ",(0,r.jsx)(n.a,{href:"./providers/apple/setup",children:"Apple Provider"})," for details."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Passkey (experimental)"}),": Sign-in with Passkey. See ",(0,r.jsx)(n.a,{href:"./providers/passkey/setup",children:"Passkey Provider"})," for details."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"By default, endpoints for all providers are disabled. To enable a provider, it is necessary to:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Pass its config object to the ",(0,r.jsx)(n.code,{children:"identityProviderBuilders"})," parameter of the ",(0,r.jsx)(n.code,{children:"pod.initializeAuthServices()"})," method."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"pod.initializeAuthServices(\n  identityProviderBuilders: [\n    EmailIdpConfig( /* configuration options */ ),\n  ],\n);\n"})}),"\n",(0,r.jsx)(n.admonition,{type:"tip",children:(0,r.jsx)(n.p,{children:"Some identity providers might require configuration on external services, such as the Google client secret. Such configuration will be required by the provider config object."})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Extend the identity provider abstract endpoint."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"import 'package:serverpod_auth_idp_server/providers/email.dart';\n\nclass EmailIdpEndpoint extends EmailIdpBaseEndpoint {}\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Run ",(0,r.jsx)(n.code,{children:"serverpod generate"})," to generate the client code and endpoint methods for the provider."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"$ serverpod generate\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Create a migration to initialize the database for the provider."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Create the migration\n$ serverpod create-migration\n\n# Start the database container\n$ docker compose up --build --detach\n\n# Apply the migration\n$ dart run bin/main.dart --role maintenance --apply-migrations\n"})}),"\n",(0,r.jsx)(n.admonition,{type:"info",children:(0,r.jsxs)(n.p,{children:["If this is the first time creating migrations after adding the module, besides the provider tables, all auth module tables will also be created. More detailed migration instructions can be found in the ",(0,r.jsx)(n.a,{href:"../database/migrations",children:"migration guide"}),"."]})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"storing-secrets",children:"Storing Secrets"}),"\n",(0,r.jsxs)(n.p,{children:["Secrets like peppers and private keys should be stored securely. The example above uses ",(0,r.jsx)(n.code,{children:"pod.getPassword()"})," which reads from your ",(0,r.jsx)(n.code,{children:"config/passwords.yaml"})," file or environment variables in the format ",(0,r.jsx)(n.code,{children:"SERVERPOD_PASSWORD_<key>='value'"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["Add secrets to ",(0,r.jsx)(n.code,{children:"config/passwords.yaml"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"development:\n  serverSideSessionKeyHashPepper: 'your-session-pepper-here'\n  jwtRefreshTokenHashPepper: 'your-refresh-token-pepper-here'\n  jwtHmacSha512PrivateKey: 'your-private-key-here'\n  emailSecretHashPepper: 'your-email-pepper-here'\n  googleClientSecret: '{\"type\":\"service_account\",...}'\n  # ... other secrets\n"})}),"\n",(0,r.jsx)(n.p,{children:"Or use environment variables in the expected format:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"export SERVERPOD_PASSWORD_serverSideSessionKeyHashPepper='your-session-pepper-here'\nexport SERVERPOD_PASSWORD_jwtRefreshTokenHashPepper='your-refresh-token-pepper-here'\nexport SERVERPOD_PASSWORD_jwtHmacSha512PrivateKey='your-private-key-here'\nexport SERVERPOD_PASSWORD_emailSecretHashPepper='your-email-pepper-here'\nexport SERVERPOD_PASSWORD_googleClientSecret='{\"type\":\"service_account\",...}'\n# ... other secrets\n"})}),"\n",(0,r.jsxs)(n.admonition,{type:"info",children:[(0,r.jsxs)(n.p,{children:["When using the ",(0,r.jsx)(n.code,{children:"config/passwords.yaml"})," file or environment variables, you can use a convenience version of token manager and identity provider builders that already load secrets using ",(0,r.jsx)(n.code,{children:"pod.getPassword()"})," while still allowing you to pass additional configuration options."]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"final jwtConfig = JwtConfigFromPasswords();\nfinal serverSideSessionsConfig = ServerSideSessionsConfigFromPasswords();\nfinal emailIdpConfig = EmailIdpConfigFromPasswords();\nfinal googleIdpConfig = GoogleIdpConfigFromPasswords();\nfinal appleIdpConfig = AppleIdpConfigFromPasswords();\nfinal passkeyIdpConfig = PasskeyIdpConfigFromPasswords();\n"})})]}),"\n",(0,r.jsx)(n.admonition,{type:"warning",children:(0,r.jsxs)(n.p,{children:["Never commit ",(0,r.jsx)(n.code,{children:"config/passwords.yaml"})," to version control. Be sure to add it to your ",(0,r.jsx)(n.code,{children:".gitignore"})," file. Prefer environment variables or secure secret management in production."]})}),"\n",(0,r.jsx)(n.h2,{id:"client-setup",children:"Client setup"}),"\n",(0,r.jsxs)(n.p,{children:["Add the ",(0,r.jsx)(n.code,{children:"serverpod_auth_idp_client"})," package to your client project's ",(0,r.jsx)(n.code,{children:"pubspec.yaml"}),". Make sure to use the same version numbers as for Serverpod itself for all dependencies."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"dependencies:\n  ...\n  serverpod_auth_idp_client: 3.x.x\n"})}),"\n",(0,r.jsx)(n.h2,{id:"app-setup",children:"App setup"}),"\n",(0,r.jsxs)(n.p,{children:["First, add dependencies to your app's ",(0,r.jsx)(n.code,{children:"pubspec.yaml"})," file for the methods of signing in that you want to support."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"dependencies:\n  flutter:\n    sdk: flutter\n  serverpod_auth_idp_flutter: 3.x.x\n  serverpod_flutter: 3.x.x\n  your_client:\n    path: ../your_client\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Next, you need to set up a ",(0,r.jsx)(n.code,{children:"FlutterAuthSessionManager"}),", which keeps track of the user's authentication state. It handles authentication tokens, token storage and refresh, and user session management."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"import 'package:flutter/material.dart';\nimport 'package:serverpod_flutter/serverpod_flutter.dart';\nimport 'package:serverpod_auth_idp_flutter/serverpod_auth_idp_flutter.dart';\nimport 'package:your_client/your_client.dart';\n\nlate Client client;\n\nvoid main() async {\n  WidgetsFlutterBinding.ensureInitialized();\n\n  const serverUrl = 'http://localhost:8080/';\n\n  // Create the client with the auth session manager\n  client = Client(serverUrl)\n    ..connectivityMonitor = FlutterConnectivityMonitor()\n    ..authSessionManager = FlutterAuthSessionManager();\n\n  // Initialize authentication (restores session from storage and validates)\n  await client.auth.initialize();\n\n  runApp(MyApp());\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"FlutterAuthSessionManager"})," provides useful properties and methods for managing authentication state."]}),"\n",(0,r.jsx)(n.admonition,{type:"tip",children:(0,r.jsxs)(n.p,{children:["In case you have an endpoint called ",(0,r.jsx)(n.code,{children:"AuthEndpoint"})," - that will generate the ",(0,r.jsx)(n.code,{children:"auth"})," getter on the client -, you can also get the ",(0,r.jsx)(n.code,{children:"FlutterAuthSessionManager"})," from the client using the ",(0,r.jsx)(n.code,{children:"client.authSessionManager"})," property. On the above example, you would replace the ",(0,r.jsx)(n.code,{children:"client.auth.initialize()"})," call with ",(0,r.jsx)(n.code,{children:"client.authSessionManager.initialize()"}),"."]})}),"\n",(0,r.jsx)(n.h3,{id:"initialize-authentication",children:"Initialize authentication"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"initialize()"})," method restores any existing session from storage and validates it with the server. It should be called when your app starts:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"await client.auth.initialize();\n"})}),"\n",(0,r.jsxs)(n.p,{children:["This is equivalent to calling ",(0,r.jsx)(n.code,{children:"restore()"})," followed by ",(0,r.jsx)(n.code,{children:"validateAuthentication()"}),". If the authentication is no longer valid, the user is automatically signed out."]}),"\n",(0,r.jsxs)(n.p,{children:["See ",(0,r.jsx)(n.a,{href:"./basics#client-side-authentication",children:"Client-side authentication"})," for more details on how to interact with the authentication state from the client."]}),"\n",(0,r.jsx)(n.h3,{id:"present-the-authentication-ui",children:"Present the authentication UI"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"serverpod_auth_idp_flutter"})," package provides a ",(0,r.jsx)(n.code,{children:"SignInWidget"})," that automatically detects enabled authentication providers and displays the appropriate sign-in options."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"import 'package:flutter/material.dart';\nimport 'package:serverpod_auth_idp_flutter/serverpod_auth_idp_flutter.dart';\nimport 'package:your_client/your_client.dart';\n\nclass SignInPage extends StatelessWidget {\n  final Client client;\n\n  const SignInPage({required this.client, super.key});\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      body: SignInWidget(\n        client: client,\n        onAuthenticated: () {\n          // Navigate to home screen\n          Navigator.of(context).pushReplacement(\n            MaterialPageRoute(builder: (_) => HomePage()),\n          );\n        },\n        onError: (error) {\n          // Handle errors\n          ScaffoldMessenger.of(context).showSnackBar(\n            SnackBar(content: Text('Error: $error')),\n          );\n        },\n      ),\n    );\n  }\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["This widget is a convenient way to use identity providers out-of-the-box, but you can also fully customize it or replace it with your own implementation. See the ",(0,r.jsx)(n.a,{href:"./ui-components",children:"UI Components"})," documentation for more details."]}),"\n",(0,r.jsx)(n.h4,{id:"updating-the-ui-based-on-authentication-state",children:"Updating the UI based on authentication state"}),"\n",(0,r.jsxs)(n.p,{children:["Instead of navigating to the home screen using the ",(0,r.jsx)(n.code,{children:"onAuthenticated"})," callback, you can listen to authentication state changes and update the UI accordingly. See the ",(0,r.jsx)(n.a,{href:"./basics#monitor-authentication-changes",children:"Client-side authentication"})," section for more details."]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},87753:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/sign-in-widget-7526c61d3d53084b181f58e5c3bf6b9d.png"},28453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>o});var i=t(96540);const r={},s=i.createContext(r);function a(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);