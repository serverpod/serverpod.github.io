"use strict";(globalThis.webpackChunkserverpod_docs=globalThis.webpackChunkserverpod_docs||[]).push([[926],{66756(e,n,s){s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"concepts/authentication/working-with-users","title":"Working with users","description":"The authentication module provides convenient ways to work with your authenticated users and their related profile data.","source":"@site/versioned_docs/version-3.0.0/06-concepts/11-authentication/03-working-with-users.md","sourceDirName":"06-concepts/11-authentication","slug":"/concepts/authentication/working-with-users","permalink":"/3.0.0/concepts/authentication/working-with-users","draft":false,"unlisted":false,"editUrl":"https://github.com/serverpod/serverpod_docs/tree/main/versioned_docs/version-3.0.0/06-concepts/11-authentication/03-working-with-users.md","tags":[],"version":"3.0.0","sidebarPosition":3,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"The basics","permalink":"/3.0.0/concepts/authentication/basics"},"next":{"title":"Setup","permalink":"/3.0.0/concepts/authentication/providers/email/setup"}}');var r=s(74848),i=s(28453);const a={},o="Working with users",d={},l=[{value:"Authenticated users",id:"authenticated-users",level:2},{value:"Blocking users",id:"blocking-users",level:2},{value:"Blocking or unblocking a user",id:"blocking-or-unblocking-a-user",level:3},{value:"User creation callbacks",id:"user-creation-callbacks",level:2},{value:"Reacting to the user created event",id:"reacting-to-the-user-created-event",level:3},{value:"Setting default scopes and blocked status",id:"setting-default-scopes-and-blocked-status",level:3},{value:"User profiles",id:"user-profiles",level:2},{value:"User profile callbacks",id:"user-profile-callbacks",level:3},{value:"Accessing user profiles from the app",id:"accessing-user-profiles-from-the-app",level:3},{value:"Extending the user profile edit endpoint",id:"extending-the-user-profile-edit-endpoint",level:3},{value:"Setting a default user image",id:"setting-a-default-user-image",level:3},{value:"Attaching additional information",id:"attaching-additional-information",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"working-with-users",children:"Working with users"})}),"\n",(0,r.jsx)(n.p,{children:"The authentication module provides convenient ways to work with your authenticated users and their related profile data."}),"\n",(0,r.jsx)(n.h2,{id:"authenticated-users",children:"Authenticated users"}),"\n",(0,r.jsxs)(n.p,{children:["All authenticated users have an authentication identifier, that uniquely identifies them across the server. This can be retrieved from the ",(0,r.jsx)(n.code,{children:"session"})," object as a ",(0,r.jsx)(n.code,{children:"String"})," through the ",(0,r.jsx)(n.code,{children:"userIdentifier"})," property or as a ",(0,r.jsx)(n.code,{children:"UuidValue"})," from the ",(0,r.jsx)(n.code,{children:"authUserId"})," extension provided by the authentication module."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"var userIdString = session.authenticated?.userIdentifier;\n// requires `import 'package:serverpod_auth_idp_server/serverpod_auth_idp_server.dart';`\nvar userIdUuidValue = session.authenticated?.authUserId;\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Further operations on the authenticated user can be performed using the ",(0,r.jsx)(n.code,{children:"AuthUsers"})," class which is provide by the ",(0,r.jsx)(n.code,{children:"AuthServices"})," instance."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"await AuthServices.instance.authUsers.delete(session, userIdUuidValue);\n"})}),"\n",(0,r.jsxs)(n.p,{children:["For the full list of operations, see the ",(0,r.jsx)(n.a,{href:"https://pub.dev/documentation/serverpod_auth_core_server/latest/serverpod_auth_core_server/AuthUsers-class.html",children:"AuthUsers"})," class documentation."]}),"\n",(0,r.jsx)(n.h2,{id:"blocking-users",children:"Blocking users"}),"\n",(0,r.jsxs)(n.p,{children:["You can block users to prevent them from signing in to your application. When a blocked user attempts to authenticate, an ",(0,r.jsx)(n.code,{children:"AuthUserBlockedException"})," will be thrown, and the authentication will fail."]}),"\n",(0,r.jsx)(n.h3,{id:"blocking-or-unblocking-a-user",children:"Blocking or unblocking a user"}),"\n",(0,r.jsxs)(n.p,{children:["To block/unblock a user, use the ",(0,r.jsx)(n.code,{children:"update"})," method of the ",(0,r.jsx)(n.code,{children:"AuthUsers"})," class:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"await AuthServices.instance.authUsers.update(\n  session,\n  authUserId: authUserId,\n  blocked: true, // or false to unblock\n);\n"})}),"\n",(0,r.jsx)(n.p,{children:"Users can also be created with the blocked status set from the start:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"await AuthServices.instance.authUsers.create(\n  session,\n  blocked: true,\n);\n"})}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsxs)(n.p,{children:["When a user is blocked, they will not be able to sign in until they are unblocked. However, blocking a user does not automatically revoke their existing sessions. Be sure to revoke existing sessions for a complete block operation. See ",(0,r.jsx)(n.a,{href:"./token-managers/managing-tokens#revoking-tokens",children:"Revoking tokens"})," for more details."]})}),"\n",(0,r.jsx)(n.h2,{id:"user-creation-callbacks",children:"User creation callbacks"}),"\n",(0,r.jsxs)(n.p,{children:["You can react when an auth user is created and control their initial scopes and blocked status by using the ",(0,r.jsx)(n.code,{children:"AuthUsersConfig"})," callbacks. Configure them when initializing auth services on the ",(0,r.jsx)(n.code,{children:"pod"})," object."]}),"\n",(0,r.jsx)(n.admonition,{type:"warning",children:(0,r.jsxs)(n.p,{children:["Both callbacks receive a ",(0,r.jsx)(n.code,{children:"transaction"})," parameter that should be used on all operations performed inside the callback. Failing to pass the transaction to database operations might lead to entries not being found or changes not being rolled back together."]})}),"\n",(0,r.jsx)(n.h3,{id:"reacting-to-the-user-created-event",children:"Reacting to the user created event"}),"\n",(0,r.jsxs)(n.p,{children:["Use the ",(0,r.jsx)(n.code,{children:"onAfterAuthUserCreated"})," callback to run logic after a new auth user has been created (for example, to create related domain data or send a welcome notification). The callback receives the current session, the newly created auth user, and the ongoing transaction."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"pod.initializeAuthServices(\n  ...\n  authUsersConfig: AuthUsersConfig(\n    onAfterAuthUserCreated: (session, authUser, {required transaction}) {\n      // Do something with the new auth user (e.g. create related data)\n    },\n  ),\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"setting-default-scopes-and-blocked-status",children:"Setting default scopes and blocked status"}),"\n",(0,r.jsxs)(n.p,{children:["Use the ",(0,r.jsx)(n.code,{children:"onBeforeAuthUserCreated"})," callback to set default scopes or blocked status for new auth users. The callback receives the session, the scopes and blocked value that would be used by default, and the transaction. Return a record with the ",(0,r.jsx)(n.code,{children:"scopes"})," and ",(0,r.jsx)(n.code,{children:"blocked"})," values you want to apply; you can add or remove scopes or force the user to be blocked."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"pod.initializeAuthServices(\n  ...\n  authUsersConfig: AuthUsersConfig(\n    onBeforeAuthUserCreated: (session, scopes, blocked, {required transaction}) {\n      // Set default scopes (e.g. add Scope.admin) and optionally block the user\n      return (scopes: {...scopes, Scope.admin}, blocked: blocked);\n    },\n  ),\n);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"user-profiles",children:"User profiles"}),"\n",(0,r.jsxs)(n.p,{children:["By default, all authenticated users have a ",(0,r.jsx)(n.code,{children:"UserProfile"})," object that contains information about the signed-in user. To access the ",(0,r.jsx)(n.code,{children:"UserProfile"})," object, you can use the ",(0,r.jsx)(n.code,{children:"userProfile"})," extension on the ",(0,r.jsx)(n.code,{children:"AuthenticationInfo"})," object."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"var userProfile = await session.authenticated?.userProfile(session);\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"UserProfile"})," contains a basic set of information about the user, such as their full name, email address, and profile picture."]}),"\n",(0,r.jsx)(n.p,{children:"This information is automatically populated when the user signs in. Based on the authentication method used, different data may be available."}),"\n",(0,r.jsxs)(n.p,{children:["It's a common task to read or update user information on your server. The ",(0,r.jsx)(n.code,{children:"UserProfiles"})," class provides many convenient methods for working with user profiles and is accessible through the ",(0,r.jsx)(n.code,{children:"AuthServices"})," instance."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"await AuthServices.instance.userProfiles.changeFullName(session, authUserId, 'my name');\n"})}),"\n",(0,r.jsxs)(n.p,{children:["For the full list of operations, see the ",(0,r.jsx)(n.a,{href:"https://pub.dev/documentation/serverpod_auth_core_server/latest/serverpod_auth_core_server/UserProfiles-class.html",children:"UserProfiles"})," class documentation."]}),"\n",(0,r.jsx)(n.h3,{id:"user-profile-callbacks",children:"User profile callbacks"}),"\n",(0,r.jsxs)(n.p,{children:["You can react when a user profile is created or updated by using the ",(0,r.jsx)(n.code,{children:"UserProfileConfig"})," callbacks. Configure them when initializing auth services on the ",(0,r.jsx)(n.code,{children:"pod"})," object via the ",(0,r.jsx)(n.code,{children:"userProfileConfig"})," parameter."]}),"\n",(0,r.jsx)(n.admonition,{type:"warning",children:(0,r.jsxs)(n.p,{children:["All callbacks receive a ",(0,r.jsx)(n.code,{children:"transaction"})," parameter that should be used on all database operations performed inside the callback. Failing to pass the transaction might lead to entries not being found or changes not being rolled back together."]})}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Callback"}),(0,r.jsx)(n.th,{children:"When"}),(0,r.jsx)(n.th,{children:"Purpose"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"onBeforeUserProfileCreated"})}),(0,r.jsx)(n.td,{children:"Before a profile is created"}),(0,r.jsxs)(n.td,{children:["Receive and return ",(0,r.jsx)(n.code,{children:"UserProfileData"})," to modify defaults (user name, full name, email)."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"onAfterUserProfileCreated"})}),(0,r.jsx)(n.td,{children:"After a profile is created"}),(0,r.jsx)(n.td,{children:"Run logic that depends on the new profile (e.g. related data, default image)."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"onBeforeUserProfileUpdated"})}),(0,r.jsx)(n.td,{children:"Before a profile is updated (name, full name, or picture)"}),(0,r.jsxs)(n.td,{children:["Receive and return ",(0,r.jsx)(n.code,{children:"UserProfileData"})," to enforce rules or transform values."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"onAfterUserProfileUpdated"})}),(0,r.jsx)(n.td,{children:"After a profile is updated"}),(0,r.jsx)(n.td,{children:"Sync related data or trigger side effects."})]})]})]}),"\n",(0,r.jsxs)(n.p,{children:["Example using ",(0,r.jsx)(n.code,{children:"onAfterUserProfileCreated"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"pod.initializeAuthServices(\n  ...\n  userProfileConfig: UserProfileConfig(\n    onAfterUserProfileCreated: (session, userProfile, {required transaction}) async {\n      // Do something with the new profile (e.g. create related data, set default image)\n    },\n  ),\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"accessing-user-profiles-from-the-app",children:"Accessing user profiles from the app"}),"\n",(0,r.jsxs)(n.p,{children:["To access the user profile from your Flutter app, you can use the ",(0,r.jsx)(n.code,{children:"userProfileInfo"})," endpoint that is included in the authentication module:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"final userProfile = await client.modules.serverpod_auth_core.userProfileInfo.get();\n"})}),"\n",(0,r.jsxs)(n.p,{children:["This returns a ",(0,r.jsx)(n.code,{children:"UserProfileModel"})," object containing the logged-in user's profile information such as their name, email, and profile picture."]}),"\n",(0,r.jsx)(n.h3,{id:"extending-the-user-profile-edit-endpoint",children:"Extending the user profile edit endpoint"}),"\n",(0,r.jsxs)(n.p,{children:["The authentication module provides a ",(0,r.jsx)(n.code,{children:"UserProfileEditBaseEndpoint"})," abstract class that you can extend to expose user profile editing functionality to your app. This base endpoint includes methods for:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Removing user images"}),"\n",(0,r.jsx)(n.li,{children:"Setting user images"}),"\n",(0,r.jsx)(n.li,{children:"Changing user names"}),"\n",(0,r.jsx)(n.li,{children:"Changing full names"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["To enable profile editing in your app, create a concrete endpoint class on your server by extending ",(0,r.jsx)(n.code,{children:"UserProfileEditBaseEndpoint"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"import 'package:serverpod/serverpod.dart';\nimport 'package:serverpod_auth_idp_server/core.dart';\n\nclass UserProfileEditEndpoint extends UserProfileEditBaseEndpoint {}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["This endpoint will have both ",(0,r.jsx)(n.code,{children:"get"})," (same as ",(0,r.jsx)(n.code,{children:"userProfileInfo"}),") and all profile editing methods. You can then call these methods from your Flutter app:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"// Get the user's profile\nfinal profile = await client.userProfileEdit.get();\n\n// Change the user's full name\nfinal updatedProfile = await client.userProfileEdit.changeFullName('John Doe');\n\n// Change the user's username\nfinal updatedProfile = await client.userProfileEdit.changeUserName('johndoe');\n\n// Remove the user's profile image\nfinal updatedProfile = await client.userProfileEdit.removeUserImage();\n\n// Set a new profile image\nfinal ByteData imageData = // ... load image data\nfinal updatedProfile = await client.userProfileEdit.setUserImage(imageData);\n"})}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"UserProfileEditBaseEndpoint"})," requires authentication and operates on the currently authenticated user's profile."]})}),"\n",(0,r.jsx)(n.p,{children:"You can also extend the endpoint class to add custom profile editing functionality:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"class UserProfileEditEndpoint extends UserProfileEditBaseEndpoint {\n  Future<UserProfileModel> myCustomProfileEdit(Session session, String bio) async {\n    final userProfile = await session.authenticated?.userProfile(session);\n\n    // Your custom logic here...\n\n    return userProfile;\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"setting-a-default-user-image",children:"Setting a default user image"}),"\n",(0,r.jsxs)(n.p,{children:["When logging in from some providers, the user image is automatically fetched and set as the user's profile picture - such as with Google Sign In. However, when an image is not found or the provider does not expose the picture, you can set a default user image using the ",(0,r.jsx)(n.code,{children:"onAfterUserProfileCreated"})," callback in ",(0,r.jsx)(n.code,{children:"UserProfileConfig"})," (see ",(0,r.jsx)(n.a,{href:"#user-profile-callbacks",children:"User profile callbacks"})," for the full set of callbacks)."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"  pod.initializeAuthServices(\n    userProfileConfig: UserProfileConfig(\n      // NOTE: The `userImageGenerator` parameter is optional and defaults to\n      // the value below - which generates Gmail-style images. You can change\n      // this parameter to generate any kind of placeholder image. The function\n      // will be called when invoking the `setDefaultUserImage` method.\n      userImageGenerator: defaultUserImageGenerator,\n      onAfterUserProfileCreated:\n          (session, userProfile, {required transaction}) async {\n            await AuthServices.instance.userProfiles.setDefaultUserImage(\n              session,\n              userProfile.authUserId,\n              transaction: transaction,\n            );\n          },\n    ),\n  ...\n  );\n"})}),"\n",(0,r.jsx)(n.h2,{id:"attaching-additional-information",children:"Attaching additional information"}),"\n",(0,r.jsx)(n.p,{children:"The recommended way to attach additional information to an authenticated user is to use a relation in the Database. This makes it easy to query the data later based on the user's authentication identifier."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"class: MyDomainData\ntable: my_domain_data\nfields:\n  ### The [AuthUser] this profile belongs to\n  authUser: module:serverpod_auth_core:AuthUser?, relation(onDelete=Cascade)\n  additionalInfo: String\n\nindexes:\n  auth_user_id_unique_idx:\n    fields: authUserId\n    unique: true\n"})}),"\n",(0,r.jsxs)(n.admonition,{type:"note",children:[(0,r.jsxs)(n.p,{children:["Note that the ",(0,r.jsx)(n.code,{children:"AuthUser"})," model is declared in the ",(0,r.jsx)(n.code,{children:"serverpod_auth_core"})," module, which is automatically included in your project as a dependency of the ",(0,r.jsx)(n.code,{children:"serverpod_auth_idp"})," module. If you are not ignoring the generated files in your ",(0,r.jsx)(n.code,{children:"analysis_options.yaml"}),", you might need to explicitly add the ",(0,r.jsx)(n.code,{children:"serverpod_auth_core"})," module to your project to prevent ",(0,r.jsx)(n.code,{children:"depend_on_referenced_packages"})," lint errors. The general recommendation, however, is to ignore linting on generated files:"]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"# analysis_options.yaml\nanalyzer:\n  exclude:\n    - lib/src/generated/**\n"})})]}),"\n",(0,r.jsx)(n.admonition,{type:"tip",children:(0,r.jsxs)(n.p,{children:["When referencing module classes in your model files, you can use a nickname for the module instead of the full module name. See the ",(0,r.jsx)(n.a,{href:"../modules",children:"modules documentation"})," for more information."]})}),"\n",(0,r.jsxs)(n.p,{children:["The model above creates a relation to the ",(0,r.jsx)(n.code,{children:"AuthUser"})," table and ensures that each user can only have one ",(0,r.jsx)(n.code,{children:"MyDomainData"})," object. The ",(0,r.jsx)(n.code,{children:"onDelete=Cascade"})," ensures that when the ",(0,r.jsx)(n.code,{children:"AuthUser"})," is deleted, the ",(0,r.jsx)(n.code,{children:"MyDomainData"})," object is also deleted."]}),"\n",(0,r.jsxs)(n.p,{children:["This makes it easy to query the additional information later based on the user's ",(0,r.jsx)(n.code,{children:"authId"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dart",children:"final authUserId = session.authenticated?.authUserId;\nfinal additionalInfo = await MyDomainData.db.findFirstRow(\n    session,\n    where: (t) => t.authUserId.equals(authUserId!),\n);\n"})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},28453(e,n,s){s.d(n,{R:()=>a,x:()=>o});var t=s(96540);const r={},i=t.createContext(r);function a(e){const n=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);