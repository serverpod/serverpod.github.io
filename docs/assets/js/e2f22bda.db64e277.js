"use strict";(self.webpackChunkserverpod_docs=self.webpackChunkserverpod_docs||[]).push([[97507],{45278:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"concepts/database/runtime-parameters","title":"Runtime parameters","description":"Runtime parameters in Serverpod allow you to fine-tune the behavior of the database engine for specific queries or workloads. This can significantly improve performance, especially for complex queries or large datasets.","source":"@site/docs/06-concepts/06-database/12-runtime-parameters.md","sourceDirName":"06-concepts/06-database","slug":"/concepts/database/runtime-parameters","permalink":"/next/concepts/database/runtime-parameters","draft":false,"unlisted":false,"editUrl":"https://github.com/serverpod/serverpod_docs/tree/main/docs/06-concepts/06-database/12-runtime-parameters.md","tags":[],"version":"current","sidebarPosition":12,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Migrations","permalink":"/next/concepts/database/migrations"},"next":{"title":"Configurations","permalink":"/next/concepts/configuration"}}');var a=t(74848),s=t(28453);const i={},o="Runtime parameters",c={},l=[{value:"Parameter scopes",id:"parameter-scopes",level:2},{value:"Setting global runtime parameters on startup",id:"setting-global-runtime-parameters-on-startup",level:3},{value:"Setting transaction-scoped runtime parameters",id:"setting-transaction-scoped-runtime-parameters",level:3},{value:"Parameter groups",id:"parameter-groups",level:2},{value:"Combining multiple parameter groups",id:"combining-multiple-parameter-groups",level:3},{value:"Creating custom runtime parameters",id:"creating-custom-runtime-parameters",level:3},{value:"Using <code>MapRuntimeParameters</code>",id:"using-mapruntimeparameters",level:4},{value:"Extending <code>RuntimeParameters</code>",id:"extending-runtimeparameters",level:4},{value:"Parameter values",id:"parameter-values",level:3},{value:"Database schema search paths",id:"database-schema-search-paths",level:2},{value:"Vector runtime parameters",id:"vector-runtime-parameters",level:2},{value:"General vector query optimization",id:"general-vector-query-optimization",level:3},{value:"HNSW index optimization",id:"hnsw-index-optimization",level:3},{value:"IVFFLAT index optimization",id:"ivfflat-index-optimization",level:3},{value:"Iterative scan modes",id:"iterative-scan-modes",level:3},{value:"Testing with runtime parameters",id:"testing-with-runtime-parameters",level:2},{value:"Global test configuration",id:"global-test-configuration",level:3},{value:"Ensuring vector extension for runtime parameter tests",id:"ensuring-vector-extension-for-runtime-parameter-tests",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"runtime-parameters",children:"Runtime parameters"})}),"\n",(0,a.jsx)(n.p,{children:"Runtime parameters in Serverpod allow you to fine-tune the behavior of the database engine for specific queries or workloads. This can significantly improve performance, especially for complex queries or large datasets."}),"\n",(0,a.jsx)(n.admonition,{type:"warning",children:(0,a.jsx)(n.p,{children:"Setting runtime parameters affects PostgreSQL's query planning and execution. Always test different parameter combinations with your specific dataset and query patterns to find the optimal configuration."})}),"\n",(0,a.jsx)(n.h2,{id:"parameter-scopes",children:"Parameter scopes"}),"\n",(0,a.jsx)(n.p,{children:"Runtime parameters can be applied with different scopes:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Global scope"}),": Parameters set at Serverpod startup that affect all database connections and sessions."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Transaction scope"}),": Parameters that only affect queries within a specific transaction."]}),"\n"]}),"\n",(0,a.jsx)(n.admonition,{type:"info",children:(0,a.jsx)(n.p,{children:"Due to connection pooling, runtime parameters cannot be set at the session level as this would create inconsistencies between different database connections. Parameters must be either global (set at startup) or transaction-scoped."})}),"\n",(0,a.jsx)(n.h3,{id:"setting-global-runtime-parameters-on-startup",children:"Setting global runtime parameters on startup"}),"\n",(0,a.jsxs)(n.p,{children:["To set global runtime parameters that apply to all database sessions, configure them when initializing your Serverpod instance. Add the runtime parameters configuration in the ",(0,a.jsx)(n.code,{children:"run"})," function of your ",(0,a.jsx)(n.code,{children:"lib/server.dart"})," file:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"import 'package:serverpod/serverpod.dart';\n\nimport 'src/generated/protocol.dart';\nimport 'src/generated/endpoints.dart';\n\n/// The starting point of the Serverpod server.\nvoid run(List<String> args) async {\n  // Initialize Serverpod and connect it with your generated code.\n  final pod = Serverpod(\n    args,\n    Protocol(),\n    Endpoints(),\n    // Set global runtime parameters that apply to all database sessions.\n    runtimeParametersBuilder: (params) => [\n      params.vectorIndexQuery(enableIndexScan: true),\n      params.hnswIndexQuery(efSearch: 64),\n    ],\n  );\n\n  // Start the server\n  await pod.start();\n}\n"})}),"\n",(0,a.jsx)(n.h3,{id:"setting-transaction-scoped-runtime-parameters",children:"Setting transaction-scoped runtime parameters"}),"\n",(0,a.jsxs)(n.p,{children:["To set runtime parameters that only apply to queries within a specific transaction, use the ",(0,a.jsx)(n.code,{children:"setRuntimeParameters"})," method on the transaction object:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"// Transaction scope - only affects current transaction\nawait session.db.transaction((transaction) async {\n  await transaction.setRuntimeParameters((params) => [\n    params.hnswIndexQuery(efSearch: 40),\n  ]);\n\n  var results = await Document.db.find(\n    session,\n    where: (t) => t.embedding.distanceCosine(queryVector) < 0.5,\n    limit: 10,\n    orderBy: (t) => t.embedding.distanceCosine(queryVector),\n    transaction: transaction,\n  );\n\n  return results;\n});\n"})}),"\n",(0,a.jsx)(n.p,{children:"These parameters will override any global settings for the duration of the transaction, allowing you to fine-tune query behavior without affecting other transactions or sessions."}),"\n",(0,a.jsx)(n.h2,{id:"parameter-groups",children:"Parameter groups"}),"\n",(0,a.jsx)(n.p,{children:"Runtime parameters are set as groups of related settings that control various aspects of query execution. You can use the builder pattern to create these parameter groups, that will always set all parameters in a consistent way."}),"\n",(0,a.jsx)(n.p,{children:"Existing parameter groups include:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Vector index query parameters"}),": Control the general behavior of index building and querying."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"HNSW index query parameters"}),": Control the behavior of HNSW index queries."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"IVFFLAT index query parameters"}),": Control the behavior of IVFFLAT index queries."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Schema search paths"}),": Control the search paths for database schemas."]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["It is also possible to ",(0,a.jsx)(n.a,{href:"#creating-custom-runtime-parameters",children:"create custom parameter groups"}),"."]}),"\n",(0,a.jsx)(n.h3,{id:"combining-multiple-parameter-groups",children:"Combining multiple parameter groups"}),"\n",(0,a.jsx)(n.p,{children:"You can combine different runtime parameter groups at once with the builder callback:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"await session.db.transaction((transaction) async {\n  await transaction.setRuntimeParameters((params) => [\n    params.vectorIndexQuery(enableIndexScan: true),\n    params.hnswIndexQuery(efSearch: 64),\n  ]);\n\n  // Your queries here...\n});\n"})}),"\n",(0,a.jsx)(n.h3,{id:"creating-custom-runtime-parameters",children:"Creating custom runtime parameters"}),"\n",(0,a.jsx)(n.p,{children:"Custom parameter groups can be created in one of two ways:"}),"\n",(0,a.jsxs)(n.h4,{id:"using-mapruntimeparameters",children:["Using ",(0,a.jsx)(n.code,{children:"MapRuntimeParameters"})]}),"\n",(0,a.jsxs)(n.p,{children:["Create an instance of the ",(0,a.jsx)(n.code,{children:"MapRuntimeParameters"})," class, which allows you to set specific parameters by name:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"import 'package:serverpod/database.dart';\n\nawait session.db.transaction((transaction) async {\n  // Clear specific parameters within this transaction\n  await transaction.setRuntimeParameters((params) => [\n    MapRuntimeParameters({\n      'param1': null,\n      'param2': 2,\n      'param3': true,\n    }),\n  ]);\n\n  // Your queries here...\n});\n"})}),"\n",(0,a.jsxs)(n.h4,{id:"extending-runtimeparameters",children:["Extending ",(0,a.jsx)(n.code,{children:"RuntimeParameters"})]}),"\n",(0,a.jsxs)(n.p,{children:["Extending the base ",(0,a.jsx)(n.code,{children:"RuntimeParameters"})," class directly, overriding the ",(0,a.jsx)(n.code,{children:"options"})," getter:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"import 'package:serverpod/database.dart';\n\nclass CustomRuntimeParameters extends RuntimeParameters {\n  final int param1;\n  final int param2;\n\n  CustomRuntimeParameters({\n    required this.param1,\n    required this.param2,\n  });\n\n  @override\n  Map<String, dynamic> get options => {\n    'custom_param': param1,\n    'another_param': param2,\n  };\n}\n"})}),"\n",(0,a.jsx)(n.h3,{id:"parameter-values",children:"Parameter values"}),"\n",(0,a.jsxs)(n.p,{children:["Values for runtime parameters can be set to specific types, such as ",(0,a.jsx)(n.code,{children:"int"}),", ",(0,a.jsx)(n.code,{children:"double"}),", ",(0,a.jsx)(n.code,{children:"bool"}),", or ",(0,a.jsx)(n.code,{children:"String"}),". When setting a parameter, you can also set it to ",(0,a.jsx)(n.code,{children:"null"})," to reset it to its default value. Some custom enums, like ",(0,a.jsx)(n.code,{children:"IterativeScan"}),", can also be used to control specific behaviors."]}),"\n",(0,a.jsx)(n.h2,{id:"database-schema-search-paths",children:"Database schema search paths"}),"\n",(0,a.jsx)(n.p,{children:"You can configure database schema search paths on either global level or within transactions for better schema resolution:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"await session.db.transaction((transaction) async {\n  // Set custom search paths for schema resolution\n  await transaction.setRuntimeParameters((params) => [\n    params.searchPaths(['my_schema', 'public']),\n  ]);\n\n  // Your queries here will use the custom search paths...\n\n  // Or reset to default search paths\n  await transaction.setRuntimeParameters((params) => [\n    params.searchPaths(), // No arguments resets to default\n  ]);\n\n  // Other queries here with default paths...\n});\n"})}),"\n",(0,a.jsx)(n.h2,{id:"vector-runtime-parameters",children:"Vector runtime parameters"}),"\n",(0,a.jsx)(n.p,{children:"When working with vector similarity searches, you can fine-tune query performance by setting runtime parameters that control the behavior of vector indexes."}),"\n",(0,a.jsx)(n.admonition,{type:"info",children:(0,a.jsx)(n.p,{children:"Runtime parameters are particularly useful when you need to balance between query speed and result quality. For real-time applications, you might prefer faster but less accurate results, while for analytical workloads, you might prioritize accuracy over speed."})}),"\n",(0,a.jsx)(n.h3,{id:"general-vector-query-optimization",children:"General vector query optimization"}),"\n",(0,a.jsx)(n.p,{children:"Use the builder pattern within transactions to configure general PostgreSQL settings that affect vector query performance:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"await session.db.transaction((transaction) async {\n  // Configure general vector query parameters\n  await transaction.setRuntimeParameters((params) => [\n    params.vectorIndexQuery(\n      enableIndexScan: true,             // Enable/disable index scans\n      enableSeqScan: false,              // Enable/disable sequential scans\n      minParallelTableScanSize: 1024,    // Min number of 8KB chunks to scan before parallelizing scans\n      parallelSetupCost: 1000,           // Estimated cost of launching parallel worker processes\n      maintenanceWorkMem: 65536,         // Memory in KB for operations such as index creation\n      maxParallelMaintenanceWorkers: 2,  // Increase to speed up index creation on large tables\n      maxParallelWorkersPerGather: 2,    // Increase to speed up queries without an index\n    ),\n  ]);\n\n  // Perform vector search with optimized PostgreSQL settings\n  var results = await Document.db.find(\n    session,\n    where: (t) => t.embedding.distanceCosine(queryVector) < 0.7,\n    orderBy: (t) => t.embedding.distanceCosine(queryVector),\n    limit: 50,\n    transaction: transaction,\n  );\n\n  return results;\n});\n"})}),"\n",(0,a.jsx)(n.h3,{id:"hnsw-index-optimization",children:"HNSW index optimization"}),"\n",(0,a.jsx)(n.p,{children:"For queries using HNSW indexes, use the builder pattern within transactions to control search behavior:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"import 'package:serverpod/serverpod.dart';\n\nawait session.db.transaction((transaction) async {\n  // Configure HNSW runtime parameters\n  await transaction.setRuntimeParameters((params) => [\n    params.hnswIndexQuery(\n      efSearch: 40,                          // Higher values = better recall, slower search\n      iterativeScan: IterativeScan.relaxed,  // Relaxed scan for better recall\n      maxScanTuples: 20000,                  // Limit number of tuples to scan\n      scanMemMultiplier: 2,                  // Memory multiplier for scanning\n    ),\n  ]);\n\n  // Your HNSW queries here...\n});\n"})}),"\n",(0,a.jsx)(n.h3,{id:"ivfflat-index-optimization",children:"IVFFLAT index optimization"}),"\n",(0,a.jsx)(n.p,{children:"For queries using IVFFLAT indexes, use the builder pattern within transactions to control search behavior:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"await session.db.transaction((transaction) async {\n  // Configure IVFFLAT runtime parameters\n  await transaction.setRuntimeParameters((params) => [\n    params.ivfflatIndexQuery(\n      probes: 10,                           // Number of probes to search (higher = better recall)\n      iterativeScan: IterativeScan.relaxed, // Relaxed scan for better recall\n      maxProbes: 20,                        // Maximum number of probes to use\n    ),\n  ]);\n\n  // Your IVFFLAT queries here...\n});\n"})}),"\n",(0,a.jsx)(n.admonition,{type:"note",children:(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"IterativeScan.strict"})," mode is not supported for IVFFLAT indexes. Use ",(0,a.jsx)(n.code,{children:"IterativeScan.relaxed"})," or ",(0,a.jsx)(n.code,{children:"IterativeScan.off"})," (default) instead."]})}),"\n",(0,a.jsx)(n.h3,{id:"iterative-scan-modes",children:"Iterative scan modes"}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"IterativeScan"})," enum controls how vector indexes handle scanning:"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:(0,a.jsx)(n.code,{children:"IterativeScan.off"})}),": Disables iterative scanning, using the default ",(0,a.jsx)(n.code,{children:"pgvector"})," behavior."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:(0,a.jsx)(n.code,{children:"IterativeScan.strict"})}),": Ensures results are in exact order by distance (better precision)."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:(0,a.jsx)(n.code,{children:"IterativeScan.relaxed"})}),": Allows slightly out-of-order results but provides better recall."]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"testing-with-runtime-parameters",children:"Testing with runtime parameters"}),"\n",(0,a.jsx)(n.p,{children:"When writing tests that use runtime parameters, you'll typically want to configure them either globally for the test suite or within specific test transactions. On transaction scope, it is the same as in production code, where you set the parameters within the transaction to ensure they only apply to that specific test case."}),"\n",(0,a.jsx)(n.h3,{id:"global-test-configuration",children:"Global test configuration"}),"\n",(0,a.jsxs)(n.p,{children:["For tests that require specific runtime parameters throughout the test suite, you can configure them using the ",(0,a.jsx)(n.code,{children:"withServerpod"})," test helper:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"import 'package:test/test.dart';\n\nimport 'test_tools/serverpod_test_tools.dart';\n\nvoid main() {\n  withServerpod(\n    'Given a server with vector runtime parameters',\n    runtimeParametersBuilder: (params) => [\n      params.vectorIndexQuery(enableIndexScan: true),\n      params.hnswIndexQuery(efSearch: 100),\n    ],\n    (sessionBuilder, endpoints) {\n      // Tests here will use the configured runtime parameters\n    },\n  );\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["This is the same as configuring the runtime parameters in the ",(0,a.jsx)(n.code,{children:"run"})," function, but it allows you to set them specifically for your test environment."]}),"\n",(0,a.jsx)(n.h3,{id:"ensuring-vector-extension-for-runtime-parameter-tests",children:"Ensuring vector extension for runtime parameter tests"}),"\n",(0,a.jsxs)(n.p,{children:["When testing runtime parameters, it is possible to find unexpected behavior of some parameters returning ",(0,a.jsx)(n.code,{children:"null"})," if queried before the vector extension is loaded. To avoid this and ensure consistent behavior, call the ",(0,a.jsx)(n.code,{children:"ensureVectorLoaded"})," method before running such tests."]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"This is not necessary for production code"}),". The only use case that it does make a difference is when explicitly querying runtime parameters that are related to vector operations before the vector extension is loaded:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dart",children:"import 'package:serverpod_test/serverpod_test.dart';\n\nvoid main() {\n  withServerpod('Given withServerpod without runtimeParametersBuilder',\n      (sessionBuilder, endpoints) {\n    var session = sessionBuilder.build();\n\n    test(\n        'when querying runtime parameters globally then expect default values',\n        () async {\n      // Ensure vector extension is loaded before, so that all vector runtime\n      // parameters have their default values set correctly.\n      await session.db.ensureVectorLoaded();\n\n      var hnswCheckQuery = HnswIndexQueryOptions().buildCheckValues();\n      var hnswResult = await session.db.unsafeQuery(hnswCheckQuery);\n      var hnswRow = hnswResult.first.toColumnMap();\n\n      // This would return null if the vector extension is not loaded, making\n      // the expect unpredictable depending on previous tests/operations.\n      expect(hnswRow['hnsw_ef_search'], '40');\n\n      await session.db.transaction((transaction) async {\n        await transaction.setRuntimeParameters((params) => [\n          params.hnswIndexQuery(efSearch: 200),\n        ]);\n\n        // Your test queries here...\n      });\n    });\n  });\n}\n"})})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>o});var r=t(96540);const a={},s=r.createContext(a);function i(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);