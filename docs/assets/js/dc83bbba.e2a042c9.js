"use strict";(globalThis.webpackChunkserverpod_docs=globalThis.webpackChunkserverpod_docs||[]).push([[55736],{55116(e,n,o){o.r(n),o.d(n,{assets:()=>c,contentTitle:()=>s,default:()=>p,frontMatter:()=>a,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"concepts/authentication/providers/anonymous/configuration","title":"Configuration","description":"This page covers configuration options for the anonymous identity provider beyond the basic setup.","source":"@site/versioned_docs/version-3.3.0/06-concepts/11-authentication/04-providers/00-anonymous/02-configuration.md","sourceDirName":"06-concepts/11-authentication/04-providers/00-anonymous","slug":"/concepts/authentication/providers/anonymous/configuration","permalink":"/concepts/authentication/providers/anonymous/configuration","draft":false,"unlisted":false,"editUrl":"https://github.com/serverpod/serverpod_docs/tree/main/versioned_docs/version-3.3.0/06-concepts/11-authentication/04-providers/00-anonymous/02-configuration.md","tags":[],"version":"3.3.0","sidebarPosition":2,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Setup","permalink":"/concepts/authentication/providers/anonymous/setup"},"next":{"title":"Customizing the UI","permalink":"/concepts/authentication/providers/anonymous/customizing-the-ui"}}');var i=o(74848),r=o(28453);const a={},s="Configuration",c={},d=[{value:"Using a token for app attestation",id:"using-a-token-for-app-attestation",level:2},{value:"Configuring the Flutter app",id:"configuring-the-flutter-app",level:3},{value:"Configuring the Server",id:"configuring-the-server",level:3},{value:"Reacting to anonymous account creation",id:"reacting-to-anonymous-account-creation",level:2},{value:"Rate limiting",id:"rate-limiting",level:2}];function u(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",strong:"strong",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"configuration",children:"Configuration"})}),"\n",(0,i.jsx)(n.p,{children:"This page covers configuration options for the anonymous identity provider beyond the basic setup."}),"\n",(0,i.jsx)(n.h2,{id:"using-a-token-for-app-attestation",children:"Using a token for app attestation"}),"\n",(0,i.jsxs)(n.p,{children:["The anonymous ",(0,i.jsx)(n.code,{children:"login"})," endpoint accepts an optional ",(0,i.jsx)(n.strong,{children:"token"})," that is forwarded to your ",(0,i.jsx)(n.code,{children:"onBeforeAnonymousAccountCreated"})," callback. This lets you tie anonymous sign-in to an app attestation or app-check provider (e.g. ",(0,i.jsx)(n.a,{href:"https://firebase.google.com/docs/app-check",children:"Firebase App Check"}),") so only requests from your real app can create anonymous accounts."]}),"\n",(0,i.jsx)(n.admonition,{type:"warning",children:(0,i.jsx)(n.p,{children:"Using the anonymous provider without a token for app attestation is not recommended due to the risk of abuse. Make sure to configure an attestation before releasing your app to the public."})}),"\n",(0,i.jsx)(n.h3,{id:"configuring-the-flutter-app",children:"Configuring the Flutter app"}),"\n",(0,i.jsxs)(n.p,{children:["Obtain a token from your app-check provider and pass it to the login call by setting ",(0,i.jsx)(n.code,{children:"createAnonymousToken"})," on ",(0,i.jsx)(n.code,{children:"AnonymousSignInWidget"})," or ",(0,i.jsx)(n.code,{children:"AnonymousAuthController"}),'. That callback is invoked when the user taps "Continue without account". The returned token is sent to the server as the ',(0,i.jsx)(n.code,{children:"token"})," argument of the anonymous login endpoint."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",children:"import 'package:firebase_app_check/firebase_app_check.dart';\nimport 'package:serverpod_auth_idp_flutter/serverpod_auth_idp_flutter.dart';\n\nAnonymousSignInWidget(\n  client: client,\n  createAnonymousToken: () async {\n    // Get a Firebase App Check token (or similar) to prove the request comes\n    // from your app to prevent abuse.\n    final appCheckToken = await FirebaseAppCheck.instance.getToken();\n    return appCheckToken;\n  },\n  onAuthenticated: () { /* ... */ },\n  onError: (error) { /* ... */ },\n)\n"})}),"\n",(0,i.jsx)(n.h3,{id:"configuring-the-server",children:"Configuring the Server"}),"\n",(0,i.jsxs)(n.p,{children:["In ",(0,i.jsx)(n.code,{children:"onBeforeAnonymousAccountCreated"}),", receive the optional ",(0,i.jsx)(n.code,{children:"token"})," and verify it with your app-check provider. If verification fails or the token is missing (when you require it), throw an ",(0,i.jsx)(n.code,{children:"AnonymousAccountBlockedException"})," with reason ",(0,i.jsx)(n.code,{children:"denied"})," to block account creation."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",children:"AnonymousIdpConfig(\n  onBeforeAnonymousAccountCreated: (\n    Session session, {\n    String? token,\n    required Transaction? transaction,\n  }) async {\n    if (token == null || token.isEmpty) {\n      throw AnonymousAccountBlockedException(\n        reason: AnonymousAccountBlockedExceptionReason.denied,\n      );\n    }\n    // Verify the token with your app-check provider (e.g. Firebase App Check).\n    // Example: call Firebase's verifyAppCheckToken REST API or your provider's\n    // verification endpoint. If invalid, throw AnonymousAccountBlockedException.\n    final isValid = await _verifyAppCheckToken(session, token);\n    if (!isValid) {\n      throw AnonymousAccountBlockedException(\n        reason: AnonymousAccountBlockedExceptionReason.denied,\n      );\n    }\n  },\n)\n"})}),"\n",(0,i.jsxs)(n.p,{children:["For Firebase App Check, you can verify the token from a custom backend using the ",(0,i.jsx)(n.a,{href:"https://firebase.google.com/docs/app-check/custom-resource-backend",children:"Firebase App Check REST API"})," (",(0,i.jsx)(n.code,{children:"verifyAppCheckToken"}),"). Other app-check or attestation providers can be integrated the same way: client sends a token, server validates it in the callback and denies creation if invalid."]}),"\n",(0,i.jsx)(n.h2,{id:"reacting-to-anonymous-account-creation",children:"Reacting to anonymous account creation"}),"\n",(0,i.jsxs)(n.p,{children:["Beside the ",(0,i.jsx)(n.code,{children:"onBeforeAnonymousAccountCreated"})," callback to allow or deny creation, you can also use the ",(0,i.jsx)(n.code,{children:"onAfterAnonymousAccountCreated"})," callback to run logic after a new anonymous account has been created (e.g. analytics or side effects)."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",children:"AnonymousIdpConfig(\n  onAfterAnonymousAccountCreated: (\n    Session session, {\n    required UuidValue authUserId,\n    required Transaction? transaction,\n  }) async {\n    // e.g. track creation for analytics or send to your logging service\n  },\n)\n"})}),"\n",(0,i.jsx)(n.h2,{id:"rate-limiting",children:"Rate limiting"}),"\n",(0,i.jsxs)(n.p,{children:["The anonymous provider includes built-in rate limiting per IP address to prevent abuse. The default is 100 anonymous account creations per hour per IP. You can customize the rate limit in the ",(0,i.jsx)(n.code,{children:"AnonymousIdpConfig"})," using the ",(0,i.jsx)(n.code,{children:"perIpAddressRateLimit"})," parameter:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dart",children:"AnonymousIdpConfig(\n  perIpAddressRateLimit: const RateLimit(\n    maxAttempts: 50,\n    timeframe: Duration(hours: 1),\n  ),\n)\n"})}),"\n",(0,i.jsxs)(n.p,{children:["When the limit is exceeded, the provider throws an ",(0,i.jsx)(n.code,{children:"AnonymousAccountBlockedException"})," with reason ",(0,i.jsx)(n.code,{children:"tooManyAttempts"}),"."]})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(u,{...e})}):u(e)}},28453(e,n,o){o.d(n,{R:()=>a,x:()=>s});var t=o(96540);const i={},r=t.createContext(i);function a(e){const n=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);